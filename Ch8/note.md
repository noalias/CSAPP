## 异常控制流
程序内部状态的变化，引起的控制转移，叫做__处理器的控制流__。

计算机系统对控制流的突变产生的反应，叫做**异常控制流**；有三个层次：_硬件层_，硬件检测到的事件触发控制转移到异常处理程序，_操作系统层_，内核通过上下文切换将控制从一个用户进程转移到另一个用户进程，_应用层_，一个进程发送信号到另一个进程，接收者会将控制转移到它的一个信号处理程序。

应用层异常控制流的一个实例，**非本地跳转**：一个程序违反通常的调用/返回栈规则的跳转来响应错误。
### 异常
处理器执行指令时，当出发事件后，通过异常表调用异常处理程序，来处理事件；异常处理程序完成后，将控制返回给1）当前指令，2）下一条指令，3）终止被中断的程序。

异常的种类：
1. **中断**：为处理由I/O设备发出的信号而引发的异常，中断不会对控制流造成影响，这样就好像中断是异步发生的，所以中断又叫异步异常。
2. **陷阱或系统调用**：陷阱是控制流调用系统调用过程主动触发的异常，系统调用处理后，返回下一条指令。
3. **故障**：由错误引起，故障程序处理后，将返回至当前指令或和终止程序。
4. **终止**：由致命错误引起，处理程序将终止程序。
### 进程
**进程**是程序运行的一个实例，在系统中任何一个程序都运行在一个进程的上下文中；上下文是指程序正常运行所需的状态，包括：程序在内存存放的数据、代码、栈、通用目的寄存器的内容、程序计数器、环境变量及打开的文件描述符。

进程的两个抽象：1）独立的逻辑控制流，2）私有的地址空间。

#### 进程逻辑流
每个进程的PC序列值叫做逻辑控制流；一个逻辑流与另一个逻辑流在时间上重叠，称为并发流；
> 流X和流Y相互并发，当且仅当X在Y开始之后和Y结束之前开始，或者Y在X开始之后或者结束之前开始。

如果两个流并发的运行在不同的处理器核或计算机上，称为**并行流**。
#### 进程地址空间
进程拥有自己的私有地址空间，地址空间中某个地址对应的内存字节是不能被其他进程读写的。但所有进程地址空间都有相同的通用结构；代码段总是从0x400000开始，之后是从可执行文件加载的只读代码段、读写代码段，然后是由malloc创建的堆，以及共享库内存映射区，用户栈；用户栈从地址2^48-1向下增长，2^48网上为内核数据段，无法被用户访问。

#### 进程上下文切换
处理器通过某个控制寄存器的模式位控制进程的访问权限，设置位模式时，进程运行在内核模式中，此时进程可以执行指令集中所有指令、访问系统中所有内存位置；没有设置位模式时，进程运行在用户模式，此时进程权限受到限制，进程只能通过系统调用访问内核代码和数据。

初始时，进程在用户模式中运行，进程可以通过异常从用户模式变为内核模式。操作系统内核使用上下文切换的异常控制流来实现多任务（上下文切换是建立在低层次异常机制上），内核为每个进程维护一个上下文（内核重新启动一个被抢占的进程所需的状态），内核**调度**进程（抢占当前运行的进程，启动之前被抢占的进程）是使用上下文切换实现的。 
>上下文切换：1）保存当前进程上下文，2）恢复先前被抢占进程的上下文，3）将控制传递给新恢复的进程。

上下文切换过程中，内核将代替
